{% extends 'base.html' %}
{% load static %}
{% block title %}
  - Registration
{% endblock %}
{% block body_content %}
  <section class="account_page d-flex align-items-center justify-content-center" style="height: 120vh;">
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>

  <div class="d-flex p-3 p-sm-5 align-items-center justify-content-center position-absolute account_box">
    <div class="d-flex w-100 align-items-center justify-content-center position-relative gap-4" style="flex-direction: column;">
      <h2 class="mb-sm-3 mb-0 form-title">Sign Up</h2>
      <form class="w-100" method="post" id="register_form">
        {% csrf_token %}
        
        {% for message in messages %}
            <div class="alert alert-warning d-flex align-items-center alert-dismissible fade show" role="alert">
                <div class="fs-6">{{ message|escape }}</div>
                <button type="button" class="btn-close ms-auto bg-transparent" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    
        <div class="row g-0 g-sm-3">
            <div class="col-12 col-sm-6 px-0 pe-sm-2">
                <label for="f_name" class="form-label">First Name</label>
                <input type="text" class="form-control shadow-none p-1" id="f_name" name="f_name" required>
            </div>
            <div class="col-12 col-sm-6 px-0 ps-sm-2">
                <label for="l_name" class="form-label">Last Name</label>
                <input type="text" class="form-control shadow-none p-1" id="l_name" name="l_name">
            </div>
        </div>
    
        <div class="my-3">
            <label for="email" class="form-label">Email Address</label>
            <input type="email" class="form-control shadow-none" id="email" name="email" autocomplete="email" required>
        </div>
    
        <div class="mb-3">
            <label for="register_mobile" class="form-label">Mobile Number</label>
            <input type="tel" class="form-control shadow-none" id="register_mobile" name="register_mobile" pattern="[0-9]{10}" required>
            <h6 class="text-danger input-warning mt-2" id="mobile-warning" style="display: none;">Please enter only numbers in the mobile field</h6>
        </div>
    
        <div class="mb-3">
            <label for="register_password" class="form-label">Password</label>
            <div class="input-group position-relative">
                <input type="password" class="form-control shadow-none p-1 password" id="register_password" name="register_password" autocomplete="new-password" required>
                <div class="input-group-text p-1 show_password">
                    <i class="fas fa-eye-slash text-white p-1"></i>
                </div>
            </div>
            <div class="p-3 password_strength">
                <h5>Password Contains</h5>
                <ul class="list-group mt-2">
                    <li class="list-group-item">At least 8 characters long</li>
                    <li class="list-group-item">At least 1 number (0-9)</li>
                    <li class="list-group-item">At least 1 lowercase letter (a-z)</li>
                    <li class="list-group-item">At least 1 uppercase letter (A-Z)</li>
                    <li class="list-group-item">At least 1 special symbol</li>
                </ul>
            </div>
        </div>
    
        <div class="mb-3">
            <label for="confirm_password" class="form-label">Confirm Password</label>
            <div class="input-group">
                <input type="password" class="form-control shadow-none p-1 password" id="confirm_password" name="confirm_password" required>
                <div class="input-group-text p-1 show_password">
                    <i class="fas fa-eye-slash text-white p-1"></i>
                </div>
            </div>
            <h6 class="text-danger input-warning mt-2" id="password-warning" style="display: none;">Doesn't match the password</h6>
        </div>
    
        <div class="d-flex align-items-center justify-content-between pt-1">
            <strong>Already have an account?</strong>
            <a href="{% url 'login' %}">Login</a>
        </div>
        
        <button class="btn btn-primary w-100 mt-sm-4 mt-3" type="submit" style="color:#161616">Register</button>
    </form>
    
    </div>
  </div>
</section>
{% endblock %}
{% block internal_script %}
<!-- Include intlTelInput CSS and JS via CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const email_input = document.querySelector('#email');
    const mobileInput = document.querySelector('#register_mobile');
    const warning_msg = document.querySelector('.input-warning');
    const f_nameInput = document.querySelector('#f_name');
    const l_nameInput = document.querySelector('#l_name');
    const password = document.getElementById('register_password');
    const confirm_password = document.getElementById('confirm_password');
    const password_strength = document.querySelectorAll('.password_strength .list-group-item');
    const pass_warning = document.getElementById('password-warning');
    const register_form = document.getElementById('register_form');

    let password_conditions = [
        { regex: /.{8}/ },         // At least 8 characters
        { regex: /\d/ },            // At least 1 number
        { regex: /[a-z]/ },         // At least 1 lowercase letter
        { regex: /[A-Z]/ },         // At least 1 uppercase letter
        { regex: /[^a-zA-Z0-9]/ }    // At least 1 special character
    ];

    // Initialize intlTelInput with custom placeholder (digits replaced with '0')
    const iti = window.intlTelInput(mobileInput, {
        initialCountry: 'auto',
        geoIpLookup: callback => {
            fetch('http://ip-api.com/json')
                .then(res => res.json())
                .then(data => callback(data.countryCode))
                .catch(() => callback('in'));
        },
        utilsScript: "{% static 'js/script.js' %}",
        customPlaceholder: function (selectedCountryPlaceholder) {
            return selectedCountryPlaceholder.replace(/\d/g, '0');
        }
    });

    // General Input Field Validation Function
    function validateInputField(input, regex, error_msg) {
        let errorElement = input.nextElementSibling;
        if (!regex.test(input.value.trim())) {
            input.classList.add('warning');
            if (!errorElement || !errorElement.classList.contains('input-warning')) {
                const errorMessage = `<h6 class="text-danger input-warning mt-2">${error_msg}</h6>`;
                input.insertAdjacentHTML('afterend', errorMessage);
            }
            return false;
        } else {
            input.classList.remove('warning');
            if (errorElement && errorElement.classList.contains('input-warning')) {
                errorElement.remove();
            }
            return true;
        }
    }

    // Attach validation on email, first name, and last name fields
    email_input.addEventListener('input', function () {
        validateInputField(email_input, /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/, 'Enter a valid email');
    });

    f_nameInput.addEventListener('input', function () {
        validateInputField(f_nameInput, /^[a-zA-Z]*$/, 'Only alphabets allowed');
    });

    l_nameInput.addEventListener('input', function () {
        validateInputField(l_nameInput, /^[a-zA-Z]*$/, 'Only alphabets allowed');
    });

    // Password Strength Checker
    password.addEventListener('input', function () {
        let allConditionsMet = true;
        password_conditions.forEach((item, i) => {
            if (item.regex.test(password.value.trim())) {
                password_strength[i].classList.add('checked');
            } else {
                password_strength[i].classList.remove('checked');
                allConditionsMet = false;
            }
        });
        document.querySelector('.password_strength').style.opacity = allConditionsMet ? 0 : 1;
    });
    
    // Password Match Checker (Reverted to original logic)
    confirm_password.addEventListener('input', function () {
        if (confirm_password.value !== password.value) {
            confirm_password.classList.add('warning');
            document.querySelector('#confirm_password ~ .input-group-text').classList.add('warning');
            pass_warning.style.display = 'block';
            valid_form = false;
        } else {
            confirm_password.classList.remove('warning');
            document.querySelector('#confirm_password ~ .input-group-text').classList.remove('warning');
            pass_warning.style.display = 'none';
            valid_form = true;
        }
    });

    // Email Validation for Allowed Domains
    register_form.onsubmit = function (event) {
        const fullPhoneNumber = iti.getNumber();
        mobileInput.value = fullPhoneNumber;

        // Check if passwords match before submission
        if (!valid_form) {
            event.preventDefault();
            return false;
        }

        // Email domain restriction
        const emailValue = email_input.value.trim();
        const allowedDomains = ["@gmail.com", "@vulnix.org"];
        const emailDomain = emailValue.substring(emailValue.lastIndexOf("@"));

        console.log("Entered email domain:", emailDomain); // Debugging log

        if (!allowedDomains.includes(emailDomain)) {
            console.log("Invalid email domain, form submission blocked.");
            alert("Only Gmail and Vulnix emails are allowed!");
            event.preventDefault();
            return false;
        }

        console.log("Valid email domain, form submitted.");
        return true;
    };
});
</script>
{% endblock %}

